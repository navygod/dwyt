<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader - Vers√£o Completa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.6s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .url-input, .folder-input, .quality-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .url-input:focus, .folder-input:focus, .quality-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .radio-option:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .video-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .video-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .video-info p {
            color: #666;
            margin-bottom: 5px;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b8d4ff;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .downloads-list {
            margin-top: 20px;
        }

        .download-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .download-item:hover {
            background: #e9ecef;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #333;
        }

        .file-details {
            color: #666;
            font-size: 0.9em;
        }

        .loading-spinner {
            display: none;
            margin: 20px auto;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
      <div class="header">
        <h1>üì• YouTube Downloader</h1>
        <p>Vers√£o Completa!</p>
      </div>
  
      <div class="main-content">
        <!-- Formul√°rio de Download -->
        <div class="card">
          <h2>üé¨ Novo Download</h2>
          
          <form id="downloadForm">
            <!-- URL e bot√£o de info -->
            <div class="form-group">
              <label for="videoUrl">üîó URL do V√≠deo:</label>
              <input type="url" id="videoUrl" class="url-input" placeholder="Cole aqui a URL do v√≠deo‚Ä¶" required>
              <button type="button" id="getInfoBtn" class="btn btn-secondary" style="margin-top: 10px;">
                üìã Obter Informa√ß√µes
              </button>
            </div>
  
            <!-- Exibi√ß√£o das infos -->
            <div id="videoInfo" class="video-info">
              <h3 id="videoTitle"></h3>
              <p><strong>Canal:</strong> <span id="videoUploader"></span></p>
              <p><strong>Dura√ß√£o:</strong> <span id="videoDuration"></span></p>
              <p><strong>Visualiza√ß√µes:</strong> <span id="videoViews"></span></p>
              <p><strong>Descri√ß√£o:</strong> <span id="videoDescription"></span></p>
            </div>
  
            <!-- Tipo de download -->
            <div class="form-group">
              <label>üìº Tipo de Download:</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="video" name="downloadType" value="video" checked>
                  <label for="video">V√≠deo Completo</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="audio" name="downloadType" value="audio">
                  <label for="audio">Apenas √Åudio</label>
                </div>
              </div>
            </div>
  
            <!-- Qualidade (ser√° populado dinamicamente) -->
            <div class="form-group">
              <label for="quality">üé• Qualidade:</label>
              <select id="quality" class="quality-select">
                <!-- vazio inicialmente -->
              </select>
            </div>
  
            <!-- Pasta de destino -->
            <div class="form-group">
              <label for="folderPath">üìÇ Pasta de Destino:</label>
              <input type="text" id="folderPath" class="folder-input" placeholder="Deixe em branco para usar 'downloads'" value="">
            </div>
  
            <button type="submit" class="btn btn-primary" style="width: 100%;">üöÄ Iniciar Download</button>
          </form>
  
          <div class="loading-spinner" id="loadingSpinner"></div>
          <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
          <div class="status-message" id="statusMessage"></div>
        </div>
  
        <!-- Lista de Downloads -->
        <div class="card">
          <h2>üìÅ Arquivos Baixados</h2>
          <button type="button" id="refreshBtn" class="btn btn-secondary">üîÑ Atualizar Lista</button>
          <div class="downloads-list" id="downloadsList"></div>
        </div>
      </div>
    </div>
  
    <script>
      let fetchedFormats = [];        // armazena os formats vindos do servidor
      let currentDownloadId = null;
      let statusCheckInterval = null;
  
      const form = document.getElementById('downloadForm');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const statusMessage = document.getElementById('statusMessage');
      const videoInfo = document.getElementById('videoInfo');
      const downloadsList = document.getElementById('downloadsList');
      const qualitySelect = document.getElementById('quality');
      const getInfoBtn = document.getElementById('getInfoBtn');
  
      function showStatus(msg, type='info') {
        statusMessage.textContent = msg;
        statusMessage.className = `status-message status-${type}`;
        statusMessage.style.display = 'block';
      }
  
      function formatDuration(sec) {
        const h = Math.floor(sec/3600);
        const m = Math.floor((sec%3600)/60);
        const s = sec%60;
        return h>0
          ? `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`
          : `${m}:${s.toString().padStart(2,'0')}`;
      }
      function formatFileSize(bytes) {
        if (bytes===0) return '0 B';
        const k=1024, sizes=['B','KB','MB','GB'], i=Math.floor(Math.log(bytes)/Math.log(k));
        return `${(bytes/Math.pow(k,i)).toFixed(2)} ${sizes[i]}`;
      }
  
      // ‚îÄ‚îÄ‚îÄ popula <select> de qualidade ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function populateQuality() {
        qualitySelect.innerHTML = '';
        const type = document.querySelector('input[name="downloadType"]:checked').value;
  
        if (type === 'audio') {
          fetchedFormats
            .filter(f => f.audioBitrate)
            .sort((a,b)=>b.audioBitrate - a.audioBitrate)
            .forEach(f => {
              const o = document.createElement('option');
              o.value = f.itag;
              o.textContent = `${f.audioBitrate} kbps`;
              qualitySelect.append(o);
            });
        } else {
          // v√≠deo: mostra todos os qualityLabel (progressive + adaptive), ordenados por height
          const seen = new Set();
          fetchedFormats
            .filter(f => f.qualityLabel)
            .sort((a,b)=> (b.height||0)-(a.height||0))
            .forEach(f => {
              if (!seen.has(f.qualityLabel)) {
                seen.add(f.qualityLabel);
                const o = document.createElement('option');
                o.value = f.itag;
                o.textContent = f.qualityLabel;
                qualitySelect.append(o);
              }
            });
        }
      }
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
      // ao mudar tipo (v√≠deo/√°udio), refaz a lista
      document.querySelectorAll('input[name="downloadType"]').forEach(radio =>
        radio.addEventListener('change', () => {
          if (fetchedFormats.length) populateQuality();
        })
      );
  
      // obter informa√ß√µes do v√≠deo e formatos
      getInfoBtn.addEventListener('click', async () => {
        const url = document.getElementById('videoUrl').value.trim();
        if (!url) { showStatus('Insira uma URL primeiro','error'); return; }
        try {
          loadingSpinner.style.display = 'block';
          showStatus('Obtendo informa√ß√µes...','info');
          const res = await fetch('/api/info', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ url })
          });
          const data = await res.json();
          if (!res.ok) { showStatus(data.error||'Erro ao obter info','error'); return; }
  
          // preenche infos b√°sicas
          document.getElementById('videoTitle').textContent = data.title;
          document.getElementById('videoUploader').textContent = data.uploader;
          document.getElementById('videoDuration').textContent = formatDuration(data.duration);
          document.getElementById('videoViews').textContent = data.view_count.toLocaleString();
          document.getElementById('videoDescription').textContent = data.description;
          videoInfo.style.display = 'block';
          showStatus('Informa√ß√µes obtidas com sucesso!','success');
  
          // armazena formats e popula dropdown de qualidade
          fetchedFormats = data.formats;
          populateQuality();
        } catch (err) {
          showStatus('Erro de conex√£o','error');
        } finally {
          loadingSpinner.style.display = 'none';
        }
      });
  
      // inicia download
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const url = document.getElementById('videoUrl').value.trim();
        const type = document.querySelector('input[name="downloadType"]:checked').value;
        const quality = qualitySelect.value;
        const folder = document.getElementById('folderPath').value.trim() || 'downloads';
  
        try {
          loadingSpinner.style.display = 'block';
          showStatus('Iniciando download...','info');
          const res = await fetch('/api/download', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ url, type, quality, folder })
          });
          const data = await res.json();
          if (!res.ok) { showStatus(data.error||'Erro ao iniciar','error'); return; }
  
          currentDownloadId = data.download_id;
          showStatus('Download iniciado!','success');
          progressBar.style.display = 'block';
          statusCheckInterval = setInterval(checkDownloadStatus, 2000);
        } catch {
          showStatus('Erro de conex√£o','error');
        } finally {
          loadingSpinner.style.display = 'none';
        }
      });
  
      // checa status
      async function checkDownloadStatus() {
        if (!currentDownloadId) return;
        try {
          const res = await fetch(`/api/status/${currentDownloadId}`);
          const d = await res.json();
          if (d.status==='completed') {
            showStatus('Download conclu√≠do!','success');
            progressFill.style.width='100%';
            clearInterval(statusCheckInterval);
            currentDownloadId=null;
            loadDownloadsList();
          } else if (d.status==='error') {
            showStatus(d.message,'error');
            clearInterval(statusCheckInterval);
            currentDownloadId=null;
          } else {
            showStatus(d.message,'info');
            // opcional: anima√ß√£o de progresso
            progressFill.style.width = `${Math.random()*100}%`;
          }
        } catch(err){
          console.error(err);
        }
      }
  
      // lista de arquivos
      async function loadDownloadsList() {
        try {
          const res = await fetch('/api/downloads');
          const files = await res.json();
          downloadsList.innerHTML = '';
          if (!files.length) {
            downloadsList.innerHTML = '<p style="text-align:center;color:#666">Nenhum arquivo baixado</p>';
            return;
          }
          files.forEach(f => {
            const item = document.createElement('div');
            item.className = 'download-item';
            item.innerHTML = `
              <div class="file-info">
                <div class="file-name">${f.name}</div>
                <div class="file-details">${formatFileSize(f.size)} ‚Ä¢ ${new Date(f.modified).toLocaleString()}</div>
              </div>
              <button class="btn btn-secondary" onclick="downloadFile('${f.name}')">üì• Baixar</button>
            `;
            downloadsList.appendChild(item);
          });
        } catch(err){
          console.error(err);
        }
      }
      function downloadFile(name) {
        window.open(`/api/download-file/${encodeURIComponent(name)}`, '_blank');
      }
  
      document.getElementById('refreshBtn').addEventListener('click', loadDownloadsList);
      loadDownloadsList();
    </script>
  </body>
  </html>